generator client {
  provider        = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  HOSPITAL_ADMIN
  RECEPTIONIST
  NURSE
  DOCTOR
  ACCOUNTANT
  PHARMACIST
  LAB_TECHNICIAN
}

enum VisitStatus {
  REGISTERED
  WAITING
  IN_CONSULTATION
  COMPLETED
  NO_SHOW
  CANCELLED
}

enum Priority {
  NORMAL
  URGENT
  EMERGENCY
}

enum CoverageType {
  SELF
  GOVERNMENT_BOOK
  NGO
  OTHER
}

enum PaymentMethod {
  CASH
  WAIVED
  PARTIAL
  OTHER
}

enum ServiceType {
  REGISTRATION
  CONSULTATION
  LABORATORY
  PHARMACY
  PROCEDURE
  RADIOLOGY
  OTHER
}

enum ClaimStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  DENIED
  REIMBURSED
}

model Tenant {
  id           String   @id @default(uuid())
  name         String
  subdomain    String   @unique
  logoUrl      String?
  primaryColor String?  @default("#3b82f6")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  users             User[]
  patients          Patient[]
  departments       Department[]
  visits            Visit[]
  insurancePolicies InsurancePolicy[]
  appointments      Appointment[]
  doctorSchedules   DoctorAvailability[]
  medications       Medication[]
}

model User {
  id        String   @id @default(uuid())
  email     String
  password  String
  firstName String
  lastName  String
  role      Role
  isActive  Boolean  @default(true)
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  tenantId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignedVisits     Visit[]       @relation("DoctorVisits")
  nursedVisits       Visit[]       @relation("NurseVisits")
  doctorAppointments Appointment[] @relation("DoctorAppointments")
  doctorSchedules    DoctorAvailability[] @relation("DoctorSchedules")

  verifiedPayments  Payments[]       @relation("CashierPayments")
  verifiedCoverages CoverageRecord[] @relation("CashierCoverages")
  voidedPayments    Payments[]       @relation("VoidedByPayments")

  // Link to specific department for queue filtering (e.g. Triage nurse, OR doctor)
  department   Department? @relation(fields: [departmentId], references: [id])
  departmentId String?

  labOrders LabOrder[] @relation("PhysicianLabOrders")
  pharmacyOrders PharmacyOrder[] @relation("PhysicianPharmacyOrders")
  dispensedOrders PharmacyOrder[] @relation("PharmacistDispensed")

  @@unique([email, tenantId])
}

model Department {
  id       String  @id @default(uuid())
  name     String
  tenant   Tenant  @relation(fields: [tenantId], references: [id])
  tenantId String
  visits   Visit[]
  users    User[]
}

model Patient {
  id          String   @id @default(uuid())
  firstName   String
  lastName    String
  dateOfBirth DateTime
  gender      String
  phone       String?
  email       String?
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  tenantId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  visits            Visit[]
  insurancePolicies InsurancePolicy[]
  appointments      Appointment[]
}

model InsurancePolicy {
  id           String       @id @default(uuid())
  type         CoverageType
  policyNumber String // Book No or Policy ID
  issuedToName String?
  issueYear    Int?
  expiryYear   Int?
  providerName String? // Name of insurance or NGO
  notes        String?      @db.Text
  isActive     Boolean      @default(true)

  patient   Patient @relation(fields: [patientId], references: [id])
  patientId String
  tenant    Tenant  @relation(fields: [tenantId], references: [id])
  tenantId  String

  coverageRecords CoverageRecord[]
  payments        Payments[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([policyNumber, tenantId])
}

model Visit {
  id       String      @id @default(uuid())
  status   VisitStatus @default(REGISTERED)
  priority Priority    @default(NORMAL)
  reason   String?

  // Relations
  patient      Patient    @relation(fields: [patientId], references: [id])
  patientId    String
  tenant       Tenant     @relation(fields: [tenantId], references: [id])
  tenantId     String
  department   Department @relation(fields: [departmentId], references: [id])
  departmentId String

  // Staff
  doctor   User?   @relation("DoctorVisits", fields: [doctorId], references: [id])
  doctorId String?
  nurse    User?   @relation("NurseVisits", fields: [nurseId], references: [id])
  nurseId  String?

  // Clinical data (lightweight)
  vitals       Vitals?
  consultation Consultation?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payments    Payments[]
  coverage    CoverageRecord?
  appointment Appointment?
  labOrders   LabOrder[]
  pharmacyOrders PharmacyOrder[]
}

model Vitals {
  id          String   @id @default(uuid())
  height      Float?
  weight      Float?
  bpSystolic  Int?
  bpDiastolic Int?
  temperature Float?
  pulse       Int?
  notes       String?
  visit       Visit    @relation(fields: [visitId], references: [id])
  visitId     String   @unique
  createdAt   DateTime @default(now())
}

model Consultation {
  id           String   @id @default(uuid())
  notes        String   @db.Text
  prescription String?  @db.Text
  visit        Visit    @relation(fields: [visitId], references: [id])
  visitId      String   @unique
  createdAt    DateTime @default(now())

  attachments Attachment[]
}

model LabOrder {
  id          String   @id @default(uuid())
  testName    String
  instructions String?  @db.Text
  status      String   @default("ORDERED") // ORDERED, COLLECTED, COMPLETED, CANCELLED
  result      String?  @db.Text
  
  visit       Visit    @relation(fields: [visitId], references: [id])
  visitId     String
  
  prescribedBy   User   @relation("PhysicianLabOrders", fields: [prescribedById], references: [id])
  prescribedById String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Attachment {
  id             String       @id @default(uuid())
  fileUrl        String
  fileName       String
  fileType       String
  consultation   Consultation @relation(fields: [consultationId], references: [id])
  consultationId String
  createdAt      DateTime     @default(now())
}

model CoverageRecord {
  id              String       @id @default(uuid())
  type            CoverageType @default(SELF)
  referenceNumber String? // Legacy or snapshot Book number
  issuedToName    String?
  issueYear       Int?
  expiryYear      Int?

  notes String? @db.Text

  claimStatus ClaimStatus @default(SUBMITTED)

  // Relationship
  visit   Visit  @relation(fields: [visitId], references: [id])
  visitId String @unique

  // Link to persistent policy
  insurancePolicy   InsurancePolicy? @relation(fields: [insurancePolicyId], references: [id])
  insurancePolicyId String?

  // Verification
  verifiedBy   User?    @relation("CashierCoverages", fields: [verifiedById], references: [id])
  verifiedById String?
  verifiedAt   DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payments {
  id            String        @id @default(uuid())
  amountCharged Decimal       @db.Decimal(10, 2)
  amountPaid    Decimal       @db.Decimal(10, 2)
  method        PaymentMethod @default(CASH)
  serviceType   ServiceType   @default(CONSULTATION)
  status        String        @default("COMPLETED") // PENDING, COMPLETED, FAILED
  reason        String? // e.g. "Covered by Gov Book"

  // Audit/Voiding
  isVoided     Boolean   @default(false)
  voidReason   String?
  voidedAt     DateTime?
  voidedById   String?
  voidedBy     User?     @relation("VoidedByPayments", fields: [voidedById], references: [id])

  // Relationship
  visit   Visit  @relation(fields: [visitId], references: [id])
  visitId String

  // Link to policy for reporting
  insurancePolicy   InsurancePolicy? @relation(fields: [insurancePolicyId], references: [id])
  insurancePolicyId String?

  // Verification (Cashier)
  verifiedBy   User?   @relation("CashierPayments", fields: [verifiedById], references: [id])
  verifiedById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

model Appointment {
  id        String            @id @default(uuid())
  status    AppointmentStatus @default(SCHEDULED)
  startTime DateTime
  endTime   DateTime
  reason    String?           @db.Text
  notes     String?           @db.Text

  patient   Patient @relation(fields: [patientId], references: [id])
  patientId String
  doctor    User?   @relation("DoctorAppointments", fields: [doctorId], references: [id])
  doctorId  String?
  tenant    Tenant  @relation(fields: [tenantId], references: [id])
  tenantId  String

  // Optional: Link to a resulting visit
  visit   Visit?  @relation(fields: [visitId], references: [id])
  visitId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DoctorAvailability {
  id        String   @id @default(uuid())
  dayOfWeek Int      // 0-6 (Sunday to Saturday)
  startTime String   // HH:mm format
  endTime   String   // HH:mm format
  isActive  Boolean  @default(true)

  doctor    User     @relation("DoctorSchedules", fields: [doctorId], references: [id])
  doctorId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  tenantId  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([doctorId, dayOfWeek, tenantId])
}

model Medication {
  id           String   @id @default(uuid())
  name         String
  genericName  String?
  dosageForm   String   // Tablet, Syrup, Injection, etc.
  strength     String   // 500mg, 5ml, etc.
  stockBalance Float    @default(0)
  unitPrice    Decimal  @db.Decimal(10, 2)
  
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  tenantId     String

  orders       PharmacyOrder[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([name, strength, tenantId])
}

model PharmacyOrder {
  id             String   @id @default(uuid())
  medicationId   String
  medication     Medication @relation(fields: [medicationId], references: [id])
  
  quantity       Float
  instructions   String?  @db.Text
  status         String   @default("PENDING") // PENDING, DISPENSED, CANCELLED
  
  visit          Visit    @relation(fields: [visitId], references: [id])
  visitId        String
  
  prescribedBy   User     @relation("PhysicianPharmacyOrders", fields: [prescribedById], references: [id])
  prescribedById String
  
  dispensedBy    User?    @relation("PharmacistDispensed", fields: [dispensedById], references: [id])
  dispensedById  String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}
